<script>
	/* Assert APP_MODEL properties */

	console.assert(window.APP_MODEL.hasOwnProperty('ua_file_label_model_id'))
	console.assert(window.APP_MODEL.hasOwnProperty('nbserver_auth_token'))

	/* Clickaway listener for notification */

	document.addEventListener('mousedown', function(event) {  // cannot be 'click' as it will interfere with the 'blur'
		notification = document.getElementsByClassName('c-notification')[0]
		// Ignore if user clicks inside notification
		if (notification === undefined || notification.contains(event.target)) {
			return;
		}
		// Hide the notification
		// Note that doing this will only modify the notification view, without changing the notification model. The 
		// model will still think that the removed CSS class is present in the view
		// We will reset the model's CSS classes in the server-side the next time the notification is being shown again.
		notification.classList.remove("c-notification--show")
	})
	
	/* Helper functions for file upload */

	function _breakFileStringIntoChunks(fileString) {
		let startIndex = 0;
		let endIndex = fileString.length;
		let chunkSize = 1024 * 1024 * 8; // 8MB
		let chunks = [];

		while (startIndex < endIndex) {
			let newStartIndex = startIndex + chunkSize;
			chunks.push(fileString.slice(startIndex, newStartIndex));
			startIndex = newStartIndex;
		}
		if (chunks.length == 0) chunks = [""]
		return chunks;
	}

	function _getUrlAndPayload(chunks, chunk_index, filename) {
		/* Return upload URL and payload */

		// Format: <BASE_URL>/notebooks/<PATH_TO_CURRENT_NOTEBOOK> or <BASE_URL>/apps/<PATH_TO_CURRENT_NOTEBOOK>
		const CURRENT_URL = window.location.href;
		if (CURRENT_URL.includes("/notebooks/"))	// Normal notebook URL
			var BASE_URL = CURRENT_URL.split("/notebooks/")[0];
		else if (CURRENT_URL.includes("/apps/"))	// URL when appmode is on 
			var BASE_URL = CURRENT_URL.split("/apps/")[0];
		else
			throw "Unexpected URL"	

		const FILE_DESTINATION_PATH = "workingdir/uploads/" + filename;
		var url = BASE_URL + "/api/contents/" + FILE_DESTINATION_PATH;

		// Jupyter's upload API requires chunk number to start with 1 and end with -1
		let chunk_number = chunk_index + 1;
		if (chunk_index == chunks.length - 1) chunk_number = -1;

		let payload = {
			content: chunks[chunk_index],
			name: filename,
			path: FILE_DESTINATION_PATH,
			format: "base64",
			type: "file",
			mimetype: "application/octet-stream",
		};
		if (chunks.length > 1) payload.chunk = chunk_number;
		
		return { url, payload };
	}

	/* Manage file uploading */

	document.getElementsByClassName("c-upload-area__file-uploader")[0].onchange = function () {
		/**
		 * Upload selected file to Jupyter notebook server
		 *
		 * This function uses the file upload API exposed by Jupyter notebook server. The signature of the API is
		 * <NB_SERVER_BASE_URL>/api/contents/<FILE_DESTINATION_PATH>
		 *
		 * To use the API:
		 *  1. Include the notebook server's auth token in the HTTP header
		 *  2. Encode the file in Base64
		 *  3. Break a large file into smaller chunks (and upload them separately)
		 *
		 * Exception:
		 *  When using a Jupyter notebook on MyGeoHub, API requests to the notebook server will reach a middleware
		 * first. The middleware will handle authentication (through cookies) and redirect the request to the server. 
		 *
		 *  As a consequence, when calling the file upload API from a notebook on MyGeoHub, step 1 mentioned above is 
		 *  not needed.
		 */

		var file = this.files[0];
		this.disabled = true;
		document.body.classList.add("c-cursor-mod--progress")
		// Encode file data in Base64 (by first reading it as an Array Buffer)
		let reader = new FileReader();
		reader.readAsArrayBuffer(file);
		reader.onload = function () {
			// Encode file data in base64
			var bytes = '';
			var buffer = new Uint8Array(reader.result);
			var nbytes = buffer.byteLength;
			for (var i=0; i<nbytes; i++) {
				bytes += String.fromCharCode(buffer[i]);
			}
			filedata = btoa(bytes);
			// Break file data into chunks
			var chunks = _breakFileStringIntoChunks(filedata);
			// Upload file in chunks 
			var chunk_index = 0
			var { url, payload } = _getUrlAndPayload(chunks, chunk_index, file.name);
			var http = null;
			var readystatechangehandler = function () {
				if (http.readyState != XMLHttpRequest.DONE) {
					return;
				}
				// OK or CREATED
				if ((http.status == 200) || (http.status == 201)) {
					// Send the next chunk, if any
					if (chunk_index < chunks.length - 1) {
						chunk_index += 1
						payload = _getUrlAndPayload(chunks, chunk_index, file.name).payload
						http = new XMLHttpRequest();
						http.open("PUT", url, true)
						// This header code can be removed before deployment to MyGeoHub 
						http.setRequestHeader("Authorization", "token " + window.APP_MODEL.nbserver_auth_token)
						http.onreadystatechange = readystatechangehandler
						http.send(JSON.stringify(payload))
					}
					// Update relevant states after sending the last chunk
					else {	
						document.body.classList.remove("c-cursor-mod--progress")
						fileUploader = document.getElementsByClassName("c-upload-area__file-uploader")[0];
						fileUploader.disabled = false;
						fileUploader.value = null;
						// Communicate the name of uploaded file to the Python backend by manipulating the model of  
						// a label associated with the file upload area (and change the label's value) 
						// https://github.com/jupyter-widgets/ipywidgets/issues/2777#issuecomment-585094635
						// https://github.com/jupyter-widgets/ipywidgets/issues/1783#issuecomment-340365890
						let manager = window.IPython.WidgetManager._managers[0]
						let model_promise = manager.get_model(window.APP_MODEL.ua_file_label_model_id)
						model_promise.then(function(model) {
							// model.views is an object containing multiple Promise attributes 
							// Assume model has only 1 view
							view_promise = model.views[Object.keys(model.views)[0]]
							view_promise.then(function(view) {
								view.model.set('value', file.name)
								view.touch()
							})
						})
					}
				}
				else {
					document.body.classList.remove("c-cursor-mod--progress")
					fileUploader = document.getElementsByClassName("c-upload-area__file-uploader")[0];
					fileUploader.disabled = false;
					fileUploader.value = null;
					alert("Fail to upload file. HTTP status: " + http.status);
				}
			}
			http = new XMLHttpRequest();
			http.open("PUT", url, true)
			// This header code can be removed before deployment to MyGeoHub 
			http.setRequestHeader("Authorization", "token " + window.APP_MODEL.nbserver_auth_token)
			http.onreadystatechange = readystatechangehandler
			http.send(JSON.stringify(payload))
		};
		// Display error message if encoding fails
		reader.onerror = function () {
			document.body.classList.remove("c-cursor-mod--progress")
			fileUploader = document.getElementsByClassName("c-upload-area__file-uploader")[0];
			fileUploader.disabled = false;
			fileUploader.value = null;
			alert("Fail to encode file in Base64");
		};
	};
</script>
